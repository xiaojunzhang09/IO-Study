---
title: 01_è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ,æ–‡ä»¶æè¿°ç¬¦,IOé‡å®šå‘
subtitle:
date: 2025-08-03T11:25:19+08:00
slug: 5f4d35a
draft: true
author:
  name:
  link:
  email:
  avatar:
description:
keywords:
license:
comment: false
weight: 0
tags:
  - draft
categories:
  - draft
hiddenFromHomePage: false
hiddenFromSearch: false
hiddenFromRelated: false
hiddenFromFeed: false
summary:
resources:
  - name: featured-image
    src: featured-image.jpg
  - name: featured-image-preview
    src: featured-image-preview.jpg
toc: true
math: false
lightgallery: false
password:
message:
repost:
  enable: true
  url:

# See details front matter: https://fixit.lruihao.cn/documentation/content-management/introduction/#front-matter
---

<!--more-->

 **VFSã€FDã€PageCacheã€Kernel** æ˜¯ Linux å†…æ ¸ I/O å­ç³»ç»Ÿä¸­éå¸¸æ ¸å¿ƒçš„å‡ ä¸ªæ¦‚å¿µï¼Œå®ƒä»¬å½¼æ­¤ä¹‹é—´æœ‰æ˜ç¡®çš„é€»è¾‘å…³ç³»ã€‚ä¸‹é¢æˆ‘å°†é€ä¸€è§£é‡Šï¼Œå¹¶ç»“åˆä¸€ä¸ªæ•´ä½“è§†è§’è¯´æ˜å®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚

------

## ğŸ” 1. å„è‡ªå®šä¹‰ä¸ä½œç”¨

### âœ… VFSï¼ˆVirtual File Systemï¼‰è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ

- VFS æ˜¯ Linux æä¾›çš„**ç»Ÿä¸€çš„æ–‡ä»¶ç³»ç»ŸæŠ½è±¡æ¥å£å±‚**ã€‚
- ä¸ç®¡ä½ æ˜¯ç”¨çš„æ˜¯ ext4ã€xfs è¿˜æ˜¯ nfsï¼ŒVFS æä¾›äº†ç»Ÿä¸€çš„æ“ä½œæ¥å£ï¼Œæ¯”å¦‚ openã€readã€writeã€closeã€‚
- ä½œç”¨ï¼š**å±è”½ä¸åŒåº•å±‚æ–‡ä»¶ç³»ç»Ÿå®ç°å·®å¼‚**ï¼Œå¯¹ä¸Šå±‚ï¼ˆå¦‚ç”¨æˆ·ç¨‹åºï¼‰æä¾›ä¸€è‡´çš„ APIã€‚

------

### âœ… FDï¼ˆFile Descriptorï¼‰æ–‡ä»¶æè¿°ç¬¦

- FD æ˜¯ç”¨æˆ·æ€è®¿é—®æ–‡ä»¶ã€socketã€ç®¡é“ç­‰èµ„æºçš„**ç´¢å¼•å¥æŸ„**ã€‚
- æ¯å½“ä½  `open()` ä¸€ä¸ªæ–‡ä»¶ï¼Œå†…æ ¸ä¼šè¿”å›ä¸€ä¸ª FDï¼ˆæ•´æ•°ï¼‰ã€‚
- FD æœ¬è´¨æ˜¯è¿›ç¨‹çº§çš„ä¸€ä¸ªæ•´æ•°ç´¢å¼•ï¼ŒæŒ‡å‘ `struct file*` ç»“æ„ä½“ã€‚
- æ˜¯ç”¨æˆ·ç©ºé—´è¿›å…¥ VFS å±‚çš„**å…¥å£**ã€‚

------

### âœ… PageCacheï¼ˆé¡µç¼“å­˜ï¼‰

- æ˜¯ Linux å†…æ ¸ä¸­ä¸€å—ç”¨äºç¼“å­˜**æ–‡ä»¶æ•°æ®é¡µ**çš„å†…å­˜åŒºåŸŸã€‚
- å½“ä½ é€šè¿‡ `read()` è¯»å–æ–‡ä»¶æ—¶ï¼Œæ•°æ®å…ˆä» PageCache æŸ¥æ‰¾ï¼Œ**å‘½ä¸­åˆ™é¿å…ç£ç›˜ I/O**ï¼ŒåŠ é€Ÿè®¿é—®ã€‚
- å½“å†™æ–‡ä»¶æ—¶ï¼Œä¹Ÿå…ˆå†™å…¥ PageCacheï¼Œä¹‹åç”±å†…æ ¸åå° `flush` åˆ°ç£ç›˜ï¼ˆå†™å›æœºåˆ¶ï¼‰ã€‚
- å±äº Linux çš„ **ç»Ÿä¸€ç¼“å­˜æœºåˆ¶ï¼ˆunified page cacheï¼‰**ã€‚

------

### âœ… Kernelï¼ˆLinux å†…æ ¸ï¼‰

- Kernel æ˜¯æ•´ä¸ªç³»ç»Ÿçš„**æ ¸å¿ƒç®¡ç†å±‚**ï¼ŒVFSã€PageCacheã€å†…å­˜ã€è¿›ç¨‹è°ƒåº¦ã€I/O å­ç³»ç»Ÿç­‰éƒ½è¿è¡Œåœ¨å…¶ä¸­ã€‚
- Kernel æä¾›ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰æ¥å£è®©ç”¨æˆ·ç©ºé—´è¿›ç¨‹è®¿é—®èµ„æºã€‚
- VFSã€PageCacheã€FD éƒ½æ˜¯ Kernel æ¨¡å—çš„ç»„æˆéƒ¨åˆ†ã€‚

------

## ğŸ” 2. å®ƒä»¬ä¹‹é—´çš„å…³ç³»ï¼ˆä»è°ƒç”¨é“¾è§’åº¦ï¼‰

### ğŸŒ ç”¨æˆ·è¿›ç¨‹è®¿é—®æ–‡ä»¶æ•°æ®æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š

```

ç”¨æˆ·æ€ç¨‹åº
   |
open("file.txt") â†’ å¾—åˆ° FDï¼ˆå¦‚ 3ï¼‰
   |
read(fd, buf, size) â†’ è°ƒç”¨ syscall
   |
â¬‡
[Linux Kernel]
   |
â†’ é€šè¿‡ FD æŸ¥æ‰¾ struct file*
   |
â†’ VFS å±‚å¤„ç†ï¼šæ ¹æ®æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼ˆext4/xfs/nfsï¼‰è°ƒç”¨å¯¹åº”å®ç°
   |
â†’ æŸ¥æ‰¾é¡µç¼“å­˜ï¼ˆPageCacheï¼‰æ˜¯å¦æœ‰è¯¥é¡µ
    â”œâ”€âœ… å‘½ä¸­ â†’ ä»å†…å­˜è¯»å– â†’ è¿”å›ç»™ç”¨æˆ·
    â””â”€âŒ æœªå‘½ä¸­ â†’ å‘èµ· block device I/Oï¼ˆä»ç£ç›˜è¯»å–ï¼‰â†’ å¡«å…… PageCache â†’ è¿”å›æ•°æ®
```

------

## ğŸ“Œ ç®€æ˜é€»è¾‘é“¾æ€»ç»“

| æ¦‚å¿µ          | æ‰€å±å±‚çº§      | ä¸»è¦ä½œç”¨                        | ä¸å…¶ä»–ç»„ä»¶å…³ç³»                                   |
| ------------- | ------------- | ------------------------------- | ------------------------------------------------ |
| **FD**        | ç”¨æˆ·æ€ / å†…æ ¸ | ç”¨æˆ·è®¿é—®æ–‡ä»¶çš„å¥æŸ„ï¼ˆç´¢å¼•ï¼‰      | æŒ‡å‘å†…æ ¸ `file*` ç»“æ„ä½“ï¼Œé€šè¿‡å®ƒè¿›å…¥ VFS          |
| **VFS**       | å†…æ ¸          | æä¾›ç»Ÿä¸€æ–‡ä»¶è®¿é—®æŠ½è±¡æ¥å£        | æ¥æ”¶æ¥è‡ª FD çš„è¯·æ±‚ï¼Œè·¯ç”±åˆ°å®é™…æ–‡ä»¶ç³»ç»Ÿ           |
| **PageCache** | å†…æ ¸          | æ–‡ä»¶æ•°æ®çš„ç¼“å­˜å±‚ï¼Œæå‡ I/O æ€§èƒ½ | è¢« VFS å±‚æŸ¥è¯¢æˆ–æ›´æ–°ï¼Œç¼“å­˜æ•°æ®é¡µ                  |
| **Kernel**    | å†…æ ¸          | æ‰¿è½½ä¸€åˆ‡ç®¡ç†åŠŸèƒ½                | å®¹çº³å¹¶è°ƒåº¦æ‰€æœ‰ç»„ä»¶ï¼Œå¦‚ VFSã€PageCacheã€block I/O |



------

## ğŸ“Œ ä¸¾ä¸ªä¾‹å­å¸®åŠ©ç†è§£

ä½ è¿è¡Œä»¥ä¸‹ä»£ç ï¼š

```
c



int fd = open("a.txt", O_RDONLY);
char buf[100];
read(fd, buf, 100);
```

å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

1. `open()` â†’ Kernel åˆ›å»º `file*`ï¼Œè¿”å› FDï¼›
2. `read()` â†’ æ ¹æ® FD æ‰¾åˆ° `file*`ï¼›
3. VFS â†’ ç¡®è®¤è¯¥æ–‡ä»¶å±äº ext4ï¼›
4. æŸ¥ PageCache çœ‹æœ‰æ²¡æœ‰æ•°æ®é¡µï¼›
5. æ²¡æœ‰çš„è¯ â†’ å‘èµ· disk read â†’ å¡« PageCacheï¼›
6. å°†æ•°æ®æ‹·è´åˆ° `buf[]`ï¼›
7. ç”¨æˆ·æ€è¯»å–å®Œæˆã€‚

------

## ğŸ§  æ‹“å±•ç†è§£

| ç±»åˆ«          | å…³é”®ç‚¹                                                 |
| ------------- | ------------------------------------------------------ |
| å¼‚æ­¥å†™        | å†™æ•°æ®æ—¶ä¸ä¼šç«‹åˆ»å†™ç£ç›˜ï¼Œè€Œæ˜¯å†™åˆ° PageCacheï¼Œç¨å flush |
| Direct I/O    | ç»•è¿‡ PageCacheï¼Œç›´æ¥å¯¹ block device è¿›è¡Œ I/O           |
| mmap æ˜ å°„æ–‡ä»¶ | ä¹Ÿæ˜¯é€šè¿‡ PageCache æ˜ å°„é¡µè®¿é—®æ–‡ä»¶                      |



------

ç»“åˆ Linux ç³»ç»Ÿçš„ `/proc`ã€`/sys/fs`ã€`vmstat` ç­‰å‘½ä»¤æ¥æŸ¥çœ‹å†…å­˜ã€æ–‡ä»¶ç³»ç»Ÿã€è™šæ‹Ÿå†…å­˜å’Œè¿›ç¨‹è°ƒåº¦ç­‰å…³é”®å†…æ ¸ç»“æ„çš„â€œå®åœ°çŠ¶æ€â€ã€‚

------



### ğŸ§  ç†è§£ Linux å†…æ ¸èµ„æºç»“æ„ï¼ˆé…åˆ /procã€/sysã€vmstatï¼‰ï¼š

```
lua


+----------------------------+
|        åº”ç”¨ç”¨æˆ·å±‚         |
+-------------+--------------+
              |
              v
+-------------+--------------+
|        Linux å†…æ ¸å±‚        |
|                            |
|  +---------+   +---------+ |
|  | è¿›ç¨‹è°ƒåº¦ |   | å†…å­˜ç®¡ç† | <--- /proc/[pid]/sched, /proc/meminfo
|  +---------+   +---------+ |
|      |              |      |
|      v              v      |
|  +--------+     +--------+ |
|  | /proc  |     | /sys/fs| <--- è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿæ¥å£ï¼Œä¾›ç”¨æˆ·æ€è¯»å–ç³»ç»Ÿä¿¡æ¯
|  +--------+     +--------+ |
+----------------------------+
```

------

## ğŸ§ª å…¸å‹å‘½ä»¤å®åœ°æŸ¥çœ‹

### 1. `/proc`ï¼šè™šæ‹Ÿå†…å­˜å’Œè¿›ç¨‹ä¿¡æ¯ï¼ˆä»å†…æ ¸å¯¼å‡ºï¼‰

#### ğŸ’¡ ç»“æ„ç¤ºæ„

```



/proc
â”œâ”€â”€ meminfo           â† å†…å­˜ä½¿ç”¨æƒ…å†µ
â”œâ”€â”€ vmstat            â† è™šæ‹Ÿå†…å­˜ç»Ÿè®¡
â”œâ”€â”€ loadavg           â† ç³»ç»Ÿè´Ÿè½½
â”œâ”€â”€ [pid]/
â”‚   â”œâ”€â”€ status        â† å•ä¸ªè¿›ç¨‹çŠ¶æ€
â”‚   â”œâ”€â”€ sched         â† è°ƒåº¦å™¨ç»Ÿè®¡
â”‚   â””â”€â”€ cmdline       â† å¯åŠ¨å‘½ä»¤
```

#### ğŸ” ç¤ºä¾‹

```




cat /proc/meminfo | head
makefile


MemTotal:       16338044 kB
MemFree:         1305428 kB
Buffers:          384684 kB
Cached:         10674876 kB
SwapTotal:       2097148 kB
SwapFree:        2097148 kB




cat /proc/1/status  # æŸ¥çœ‹ PID=1 çš„è¿›ç¨‹çŠ¶æ€
```

------

### 2. `/sys/fs`ï¼šå†…æ ¸å­ç³»ç»Ÿçš„é…ç½®æ¥å£

- `/sys/fs/cgroup`: æ§åˆ¶ç»„ (cgroup) å­ç³»ç»Ÿçš„æŒ‚è½½ç‚¹ï¼Œå±•ç¤ºè¿›ç¨‹ç»„èµ„æºé™åˆ¶
- `/sys/fs/bpf`: BPF ç¨‹åºå’Œ map ä¿¡æ¯

```


tree /sys/fs/cgroup -L 2
```

å¯è§ CPUã€memoryã€io é™åˆ¶æƒ…å†µã€‚

------

### 3. `vmstat`ï¼šåŠ¨æ€å†…å­˜ & swap & IO çŠ¶æ€

```

vmstat 1 5
```

#### ğŸ§¾ è¾“å‡ºç¤ºæ„

```

procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0  53020  31124 824204    0    0     1     2    3    6  1  0 99  0  0
```

å­—æ®µè§£é‡Šï¼š

- `r`: å¯è¿è¡Œè¿›ç¨‹æ•°é‡ï¼ˆrun queueï¼‰
- `si/so`: swap in/out
- `us/sy`: ç”¨æˆ·/ç³»ç»Ÿæ€ CPU ä½¿ç”¨ç‡
- `wa`: IO ç­‰å¾…æ—¶é—´

------

## ğŸ“Š å¯è§†åŒ–å»ºè®®ï¼ˆASCII é£æ ¼ï¼‰

### Linux è™šæ‹Ÿå†…å­˜ç»“æ„ï¼š

```
pgsql



+--------------------------+
|         å†…æ ¸ç©ºé—´         |
+--------------------------+
|         ç”¨æˆ·ç©ºé—´         |
|  +--------+             |
|  | Stack  | â† å‘ä¸‹å¢é•¿    |
|  +--------+             |
|  | Heap   | â† å‘ä¸Šå¢é•¿    |
|  +--------+             |
|  | Data   |             |
|  +--------+             |
|  | Text   |             |
+--------------------------+
```

------

### ğŸš€ ç¤ºä¾‹å®æˆ˜ï¼šæŸ¥çœ‹å½“å‰ç³»ç»Ÿè´Ÿè½½å’Œå†…å­˜å¥åº·åº¦

```




cat /proc/loadavg
```

è¾“å‡ºï¼š

```
yaml



0.05 0.03 0.01 1/135 1342
```

è¡¨ç¤ºæœ€è¿‘ 1ã€5ã€15 åˆ†é’Ÿè´Ÿè½½ï¼›`1/135` è¡¨ç¤ºæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°/æ€»çº¿ç¨‹æ•°ã€‚

------

## âœ… å°ç»“

| å·¥å…·/ç›®å½• | æŸ¥çœ‹å†…å®¹                     | å¸¸ç”¨å‘½ä»¤ç¤ºä¾‹                                  |
| --------- | ---------------------------- | --------------------------------------------- |
| `/proc`   | å†…æ ¸å¯¼å‡ºçš„è¿è¡Œæ—¶ä¿¡æ¯         | `cat /proc/meminfo`ã€`cat /proc/[pid]/status` |
| `/sys/fs` | æ–‡ä»¶ç³»ç»Ÿã€cgroupã€BPF ç­‰æ¥å£ | `tree /sys/fs/cgroup`                         |
| `vmstat`  | è¿è¡Œæ—¶èµ„æºçŠ¶æ€å¿«ç…§           | `vmstat 1 5`                                  |



# å…¶ä»–ç¬”è®°

æŸ¥çœ‹æ–‡ä»¶æºä¿¡æ¯

```
[rust@localhost ~]$ stat ooxx.txt
  File: â€˜ooxx.txtâ€™
  Size: 0         	Blocks: 0          IO Block: 4096   regular empty file
Device: 803h/2051d	Inode: 2554752     Links: 1
Access: (0664/-rw-rw-r--)  Uid: ( 1000/    rust)   Gid: ( 1000/    rust)
Context: unconfined_u:object_r:user_home_t:s0
Access: 2025-05-17 22:00:33.642686670 -0700
Modify: 2025-05-17 22:00:33.642686670 -0700
Change: 2025-05-17 22:00:33.642686670 -0700

#è½¯é“¾æ¥ Inode ä¸ä¸€æ ·
[rust@localhost ~]$ ln -s ooxx.txt zxj.txt
[rust@localhost ~]$ ll
total 0
drwxr-xr-x. 2 rust rust 6 May 17 09:17 Desktop
drwxr-xr-x. 2 rust rust 6 May 17 09:17 Documents
drwxr-xr-x. 2 rust rust 6 May 17 09:17 Downloads
drwxr-xr-x. 2 rust rust 6 May 17 09:17 Music
-rw-rw-r--. 1 rust rust 0 May 17 22:00 ooxx.txt
drwxr-xr-x. 2 rust rust 6 May 17 09:17 Pictures
drwxr-xr-x. 2 rust rust 6 May 17 09:17 Public
drwxr-xr-x. 2 rust rust 6 May 17 09:17 Templates
drwxr-xr-x. 2 rust rust 6 May 17 09:17 Videos
lrwxrwxrwx. 1 rust rust 8 Aug  2 21:35 zxj.txt -> ooxx.txt

```



```
# 1. åˆ›å»ºé•œåƒ
dd if=/dev/zero of=mydisk.img bs=1M count=100

# 2. å…³è” loop è®¾å¤‡ï¼ˆç³»ç»Ÿè‡ªåŠ¨é€‰ï¼‰
sudo losetup -fP mydisk.img

# 3. æŸ¥çœ‹å“ªä¸ª loop è®¾å¤‡å…³è”ä¸Šäº†
losetup -a

# å‡è®¾æ˜¯ /dev/loop0ï¼Œæ‰§è¡Œæ ¼å¼åŒ–
sudo mkfs.ext4 /dev/loop0

# 4. åˆ›å»ºæŒ‚è½½ç‚¹
mkdir ~/mnt/mydisk

# 5. æŒ‚è½½
sudo mount /dev/loop0 ~/mnt/mydisk

# 6. æŸ¥çœ‹æŒ‚è½½çŠ¶æ€
mount | grep mydisk

# 7. è¿›å…¥æ–‡ä»¶ç³»ç»Ÿ
cd ~/mnt/mydisk

```



```
[rust@localhost ~]$ lsof -p $$
COMMAND   PID USER   FD   TYPE DEVICE  SIZE/OFF     NODE NAME
    12591 rust  cwd    DIR    8,3      4096       70 /home/rust
    12591 rust  rtd    DIR    8,3       224       64 /
    12591 rust  txt    REG    8,3    964608 50417832 /usr/bin/
    12591 rust  mem    REG    8,3     61624   146973 /usr/lib64/libnss_files-2.17.so
    12591 rust  mem    REG    8,3 106075056 17098588 /usr/lib/locale/locale-archive
    12591 rust  mem    REG    8,3   2151672   146955 /usr/lib64/libc-2.17.so
    12591 rust  mem    REG    8,3     19288   146961 /usr/lib64/libdl-2.17.so
    12591 rust  mem    REG    8,3    174576   167495 /usr/lib64/libtinfo.so.5.9
    12591 rust  mem    REG    8,3    163400   146948 /usr/lib64/ld-2.17.so
    12591 rust  mem    REG    8,3     26254 33901061 /usr/lib64/gconv/gconv-modules.cache
    12591 rust    0u   CHR  136,2       0t0        5 /dev/pts/2
    12591 rust    1u   CHR  136,2       0t0        5 /dev/pts/2
    12591 rust    2u   CHR  136,2       0t0        5 /dev/pts/2
    12591 rust  255u   CHR  136,2       0t0        5 /dev/pts/2
```



### âœ… 1. ä»€ä¹ˆæ˜¯ `pcstat`ï¼Ÿ

`pcstat`ï¼ˆPage Cache statï¼‰æ˜¯ä¸€ä¸ªç”¨äºæŸ¥çœ‹æŸä¸ªæ–‡ä»¶åœ¨ Linux é¡µç¼“å­˜ï¼ˆPage Cacheï¼‰ä¸­å æ¯”æƒ…å†µçš„å·¥å…·ï¼Œé€šå¸¸ç”¨æ¥åˆ†æå“ªäº›æ–‡ä»¶åœ¨å†…å­˜ä¸­ã€å“ªäº›ä¸åœ¨ã€‚å®ƒ**ä¸æ”¯æŒç›´æ¥ç”¨ `-pid` æŸ¥çœ‹è¿›ç¨‹é¡µç¼“å­˜**ï¼Œä½ å¯èƒ½æƒ³ç”¨çš„å…¶å®æ˜¯åˆ«çš„å‘½ä»¤ã€‚

------

### âœ… 2. ä½ å¯èƒ½çœŸæ­£æƒ³ç”¨çš„æ˜¯ï¼š

å¦‚æœä½ æƒ³æŸ¥çœ‹å½“å‰ **è¿›ç¨‹** ä½¿ç”¨çš„å†…å­˜ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ›´å¸¸ç”¨å’Œå†…ç½®çš„æ–¹å¼ï¼š

#### ğŸ“Œ æ–¹æ³•ä¸€ï¼š`cat /proc/$$/status`

```
cat /proc/$$/status
```

ä½ å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å­—æ®µï¼š

- `VmRSS`ï¼šå®é™…ä½¿ç”¨çš„ç‰©ç†å†…å­˜
- `VmSize`ï¼šè¿›ç¨‹ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜
- `VmSwap`ï¼šè¢« swap çš„éƒ¨åˆ†

#### ğŸ“Œ æ–¹æ³•äºŒï¼š`pmap`

```
pmap $$
```

è¿™ä¼šåˆ—å‡ºå½“å‰ shell çš„å†…å­˜æ˜ å°„è¯¦æƒ…ã€‚

![image-20250803160951892](image-01.png)



# æµç¨‹å›¾

https://www.processon.com/diagraming/6820d4975af9ec6a21e8b3a1
